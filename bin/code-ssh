#!/bin/sh


show_help() {
  cat <<'EOF'
Open a remote folder in VS Code via SSH

Usage: code-ssh [-l|-i] [user@]host:path

Options:
  -i, --interactive   Use an interactive shell to resolve the remote path
  -l, --login         Use a login shell to resolve the remote path

Examples:
  code-ssh host:~/relative/path
  code-ssh user@host:~/relative/path
  code-ssh host:/absolute/path
  code-ssh -l host:~/relative/path
  code-ssh -i host:~/relative/path
EOF
}

shell_flags=""
while [ $# -gt 0 ]; do
  case "$1" in
    -h|--help) show_help; exit 0 ;;
    -i|--interactive) shell_flags="-i"; shift ;;
    -l|--login) shell_flags="-l"; shift ;;
    -*) echo "error: unknown option '$1'" >&2; exit 1 ;;
    *) break ;;
  esac
done

if ! command -v code >/dev/null 2>&1; then
  echo "error: 'code' command not found in PATH" >&2
  echo "Install it from VS Code: Cmd+Shift+P -> 'Shell Command: Install code command in PATH'" >&2
  exit 1
fi

if [ -z "$1" ]; then
  echo "usage: code-ssh [-l|-i] [user@]host:path" >&2
  exit 1
fi

# Split input on the first ':'
host="${1%%:*}"
path="${1#*:}"

if [ -z "$path" ]; then
  echo "error: no path specified (expected [user@]host:path)" >&2
  exit 1
fi

# Resolve the path on the remote host (expand ~ and verify it's a directory)
marker="__CODE_SSH_RESULT__"
resolve_cmd="path=\"$path\"; eval path=\"\$path\"; if [ -d \"\$path\" ]; then echo ${marker}\$(cd \"\$path\" && pwd)${marker}; elif [ -e \"\$path\" ]; then echo ${marker}NOT_DIR${marker}; else echo ${marker}NOT_FOUND${marker}; fi"
if [ -n "$shell_flags" ]; then
  raw=$(ssh "$host" "exec \$SHELL $shell_flags -c '$resolve_cmd'" 2>/dev/null)
else
  raw=$(ssh "$host" "$resolve_cmd" 2>/dev/null)
fi
resolved=$(printf '%s\n' "$raw" | sed -n "s/.*${marker}\(.*\)${marker}.*/\1/p")

if [ $? -ne 0 ] || [ -z "$resolved" ]; then
  echo "error: could not connect to '$host'" >&2
  exit 1
fi

case "$resolved" in
  NOT_FOUND)
    echo "error: '$path' does not exist on '$host'" >&2
    exit 1
    ;;
  NOT_DIR)
    echo "error: '$path' on '$host' is not a directory" >&2
    exit 1
    ;;
esac

code --remote=ssh-remote+"$host" "$resolved"